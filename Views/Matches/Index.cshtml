@model IEnumerable<QLBDN.Models.Match>
@using Microsoft.AspNetCore.Mvc.Rendering

@{
    Layout = "~/Views/Shared/_layout.cshtml";
    ViewData["Title"] = "L·ªãch thi ƒë·∫•u";

    var totalMatches = Model?.Count() ?? 0;

    // Danh s√°ch m√πa gi·∫£i + m√πa ƒëang ch·ªçn (t·ª´ ViewBag)
    var seasons = ViewBag.Seasons as List<SelectListItem> ?? new List<SelectListItem>();
    int? selectedSeasonId = ViewBag.SelectedSeasonId != null
        ? (int)ViewBag.SelectedSeasonId
        : (int?)null;
}

<section style="margin-bottom: 1.5rem;">
    <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: .25rem;">
        üìÖ L·ªãch thi ƒë·∫•u
    </h2>
    <p style="color: #64748b;">
        Theo d√µi danh s√°ch c√°c tr·∫≠n ƒë·∫•u trong gi·∫£i.
    </p>
</section>

<!-- Card th·ªëng k√™ -->
<div style="display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 1rem; margin-bottom: 1.5rem;">
    <div style="background: #ffffff; border-radius: 18px; padding: 1.25rem 1.5rem; box-shadow: 0 1px 3px rgba(15,23,42,0.06); display:flex; align-items:center; gap:1rem;">
        <div style="width:40px; height:40px; border-radius:999px; display:flex; align-items:center; justify-content:center; background:rgba(59,130,246,0.10);">
            üìÖ
        </div>
        <div>
            <div style="font-size:.8rem; text-transform:uppercase; letter-spacing:.06em; color:#94a3b8;">T·ªïng tr·∫≠n ƒë·∫•u</div>
            <div style="font-size:1.4rem; font-weight:700; color:#0f172a;">@totalMatches</div>
        </div>
    </div>

    <div style="background:#ffffff; border-radius:18px; padding:1.25rem 1.5rem; box-shadow:0 1px 3px rgba(15,23,42,0.06); display:flex; align-items:center; gap:1rem;">
        <div style="width:40px; height:40px; border-radius:999px; display:flex; align-items:center; justify-content:center; background:rgba(16,185,129,0.10);">
            ‚úÖ
        </div>
        <div>
            <div style="font-size:.8rem; text-transform:uppercase; letter-spacing:.06em; color:#94a3b8;">Tr·∫°ng th√°i</div>
            <div style="font-size:1.0rem; font-weight:600; color:#0f172a;">ƒêang c·∫≠p nh·∫≠t</div>
        </div>
    </div>
</div>

<!-- B·∫£ng l·ªãch thi ƒë·∫•u -->
<div style="background:#ffffff; border-radius:20px; padding:1.5rem 1.75rem; box-shadow:0 1px 3px rgba(15,23,42,0.06);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
        <div>
            <div style="font-weight:600; font-size:1.05rem; color:#0f172a;">Danh s√°ch tr·∫≠n ƒë·∫•u</div>
            <div style="font-size:.85rem; color:#94a3b8; margin-top:.15rem;">
                Hi·ªÉn th·ªã c√¢u l·∫°c b·ªô, lo·∫°i v√≤ng ƒë·∫•u v√† k·∫øt qu·∫£ tr·∫≠n ƒë·∫•u.
            </div>
        </div>

        <div style="display:flex; align-items:center; gap:.75rem;">
            <!-- Chip ch·ªçn m√πa gi·∫£i -->
            <form asp-action="Index" method="get"
                  style="display:flex; align-items:center; gap:.4rem; background:#f1f5f9; border-radius:999px; padding:.25rem .75rem;">
                <span style="font-size:.8rem; color:#64748b;">M√πa gi·∫£i</span>
                <select name="seasonId"
                        onchange="this.form.submit()"
                        style="border:none; background:transparent; font-size:.85rem; color:#0f172a; outline:none; cursor:pointer;">
                    @foreach (var s in seasons)
                    {
                        bool isSelected = selectedSeasonId.HasValue &&
                                          selectedSeasonId.Value.ToString() == s.Value;

                        <option value="@s.Value" selected="@(isSelected ? "selected" : null)">
                            @s.Text
                        </option>
                    }
                </select>
            </form>

            <!-- N√∫t th√™m tr·∫≠n ƒë·∫•u -->
            <a asp-controller="Matches"
            asp-action="Create"
            style="
                    border:none;
                    border-radius:999px;
                    padding:.55rem 1.1rem;
                    font-size:.85rem;
                    font-weight:600;
                    background:linear-gradient(135deg,#10b981,#059669);
                    color:white;
                    cursor:pointer;
                    text-decoration:none;
                    box-shadow:0 3px 12px rgba(16,185,129,0.35);
                    transition:all .25s;
                    display:inline-flex;
                    align-items:center;
                    gap:.35rem;
            "
            onmouseover="this.style.transform='translateY(-2px)'"
            onmouseout="this.style.transform='translateY(0)'">

                <span style="font-size:1rem;">‚ûï</span>
                <span>Th√™m tr·∫≠n ƒë·∫•u</span>
            </a>

        </div>
    </div>

    @if (Model == null || !Model.Any())
    {
        <div class="alert alert-info">
            Ch∆∞a c√≥ tr·∫≠n ƒë·∫•u n√†o trong h·ªá th·ªëng.
        </div>
    }
    else
    {
            <div style="overflow-x:auto;">
        <table class="table" style="width:100%; border-collapse:collapse;">
            <thead>
                <tr style="background:#f8fafc; color:#64748b; font-size:.8rem; text-transform:uppercase; letter-spacing:.06em;">
                    <th style="padding:.75rem .5rem; text-align:left;">#</th>
                    <th style="padding:.75rem .5rem; text-align:left;">CLB 1</th>
                    <th style="padding:.75rem .5rem; text-align:left;">CLB 2</th>
                    <th style="padding:.75rem .5rem; text-align:left;">K·∫øt qu·∫£</th>
                    <th style="padding:.75rem .5rem; text-align:left;">Lo·∫°i v√≤ng</th>
                    <th style="padding:.75rem .5rem; text-align:left;">Thao t√°c</th>
                </tr>
            </thead>

            <tbody>
            @{
                var i = 1;
            }
            @foreach (var m in Model)
            {
                var orderedDetails = (m.MatchDetails ?? new List<QLBDN.Models.MatchDetail>())
                    .OrderBy(d => d.IsHomeTeam == true ? 0 : 1)
                    .ToList();

                var club1 = orderedDetails.Count > 0
                    ? (orderedDetails[0].Club?.Name ?? "N/A")
                    : "N/A";

                var club2 = orderedDetails.Count > 1
                    ? (orderedDetails[1].Club?.Name ?? "N/A")
                    : "N/A";

                string score;
                if (orderedDetails.Count >= 2)
                {
                    var g1 = orderedDetails[0].Goals ?? 0;
                    var g2 = orderedDetails[1].Goals ?? 0;
                    score = $"{g1} - {g2}";
                }
                else
                {
                    score = "Ch∆∞a thi ƒë·∫•u";
                }

                var roundName = m.Round != null ? m.Round.RoundName : $"V√≤ng {m.RoundId}";
                if (m.Round != null && !string.IsNullOrEmpty(m.Round.TableName))
                {
                    roundName += $" - B·∫£ng {m.Round.TableName}";
                }

                <tr style="border-top:1px solid #e2e8f0;">
                    <td style="padding:.6rem .5rem;">@i</td>
                    <td style="padding:.6rem .5rem; font-weight:500;">@club1</td>
                    <td style="padding:.6rem .5rem; font-weight:500;">@club2</td>
                    <td style="padding:.6rem .5rem;"><strong>@score</strong></td>
                    <td style="padding:.6rem .5rem;">@roundName</td>

                    <!-- üî• N√∫t xem chi ti·∫øt -->
                    <td style="padding:.6rem .5rem; display:flex; gap:.4rem;">

                    <!-- N√∫t Xem -->
                    <a asp-action="Details"
                    asp-route-id="@m.MatchId"
                    style="
                            padding:.45rem .9rem;
                            border-radius:10px;
                            background:linear-gradient(135deg,#10b981,#059669);
                            color:white;
                            font-size:.8rem;
                            font-weight:600;
                            text-decoration:none;
                            box-shadow:0 2px 6px rgba(16,185,129,0.35);
                            transition:.2s;">
                        üëÅ Xem
                    </a>

                    <!-- N√∫t S·ª≠a -->
                    <a asp-action="Edit"
                    asp-route-id="@m.MatchId"
                    style="
                            padding:.45rem .9rem;
                            border-radius:10px;
                            background:linear-gradient(135deg,#3b82f6,#2563eb);
                            color:white;
                            font-size:.8rem;
                            font-weight:600;
                            text-decoration:none;
                            box-shadow:0 2px 6px rgba(59,130,246,0.35);
                            transition:.2s;">
                        ‚úèÔ∏è S·ª≠a
                    </a>

                    <!-- N√∫t X√≥a -->
                    <form asp-action="Delete"
                        asp-route-id="@m.MatchId"
                        method="post"
                        onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën xo√° tr·∫≠n ƒë·∫•u n√†y kh√¥ng?');">
                        <button style="
                                padding:.45rem .9rem;
                                border-radius:10px;
                                background:#dc2626;
                                color:white;
                                font-size:.8rem;
                                font-weight:600;
                                border:none;
                                cursor:pointer;
                                box-shadow:0 2px 6px rgba(220,38,38,0.35);
                                transition:.2s;">
                            üóë X√≥a
                        </button>
                    </form>

                </td>

                </tr>

                i++;
            }
            </tbody>
        </table>
    </div>

    }
</div>
